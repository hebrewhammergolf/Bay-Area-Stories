<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Beat Sheet ‚Äî Bay Area Story Scanner</title>
  <meta name="description" content="AI-powered story scanner for Bay Area reporters. Find unique, under-reported stories every morning." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üóûÔ∏è</text></svg>" />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,700&family=JetBrains+Mono:wght@400;500;700&family=Source+Serif+4:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: #0a0a0a;
      color: #e8e4df;
      font-family: 'Source Serif 4', Georgia, serif;
      min-height: 100vh;
    }

    /* API KEY SCREEN */
    .key-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 24px;
      text-align: center;
    }

    .key-screen h1 {
      font-family: 'Playfair Display', serif;
      font-size: clamp(36px, 7vw, 56px);
      font-weight: 900;
      color: #f5f0eb;
      margin-bottom: 4px;
    }

    .key-screen h1 em { color: #e63946; font-style: italic; }

    .key-screen .subtitle {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: #e63946;
      margin-bottom: 32px;
    }

    .key-screen p {
      color: #777;
      font-size: 14px;
      max-width: 440px;
      line-height: 1.6;
      margin-bottom: 24px;
    }

    .key-input-wrap {
      display: flex;
      gap: 8px;
      width: 100%;
      max-width: 500px;
      margin-bottom: 12px;
    }

    .key-input-wrap input {
      flex: 1;
      background: #111;
      border: 1px solid #333;
      color: #e8e4df;
      padding: 12px 16px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      border-radius: 4px;
      outline: none;
      transition: border-color 0.2s;
    }

    .key-input-wrap input:focus { border-color: #e63946; }
    .key-input-wrap input::placeholder { color: #444; }

    .key-input-wrap button {
      background: #e63946;
      color: #fff;
      border: none;
      padding: 12px 24px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }

    .key-input-wrap button:hover { background: #c62d3a; }

    .key-note {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: #444;
      max-width: 440px;
      line-height: 1.5;
    }

    .key-note a { color: #e63946; text-decoration: none; }
    .key-note a:hover { text-decoration: underline; }

    /* HEADER */
    .masthead {
      border-bottom: 3px double #333;
      padding: 32px 24px 24px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .masthead::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 4px;
      background: linear-gradient(90deg, #e63946, #f4a261, #e63946);
      background-size: 200% 100%;
      animation: shimmer 3s ease infinite;
    }

    @keyframes shimmer {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .edition-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      letter-spacing: 4px;
      text-transform: uppercase;
      color: #e63946;
      margin-bottom: 8px;
    }

    .masthead h1 {
      font-family: 'Playfair Display', serif;
      font-size: clamp(36px, 7vw, 64px);
      font-weight: 900;
      letter-spacing: -1px;
      line-height: 1;
      color: #f5f0eb;
      margin-bottom: 4px;
    }

    .masthead h1 em { color: #e63946; font-style: italic; }

    .top-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      margin-top: 8px;
    }

    .date-line {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: #666;
      letter-spacing: 1px;
    }

    .logout-btn {
      background: none;
      border: 1px solid #333;
      color: #555;
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      padding: 4px 10px;
      border-radius: 3px;
      cursor: pointer;
      letter-spacing: 1px;
      text-transform: uppercase;
      transition: all 0.2s;
    }

    .logout-btn:hover { border-color: #e63946; color: #e63946; }

    .greeting {
      font-family: 'Source Serif 4', serif;
      font-style: italic;
      color: #999;
      font-size: 15px;
      margin-top: 12px;
    }

    /* CATEGORY NAV */
    .category-nav {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 20px 24px;
      border-bottom: 1px solid #1a1a1a;
      justify-content: center;
    }

    .cat-btn {
      background: #111;
      border: 1px solid #222;
      color: #888;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .cat-btn:hover { background: #1a1a1a; color: #e8e4df; border-color: #333; }
    .cat-btn.active { background: #e63946; color: #fff; border-color: #e63946; }
    .cat-btn:disabled { opacity: 0.5; cursor: wait; }

    .cat-btn .dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: #333;
      display: inline-block;
    }

    .cat-btn.has-stories .dot { background: #2ecc71; }
    .cat-btn.active .dot { background: rgba(255,255,255,0.6); }

    .fetch-all-btn {
      background: transparent;
      border: 2px solid #e63946;
      color: #e63946;
      padding: 10px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      margin: 20px auto;
      display: block;
      transition: all 0.3s ease;
    }

    .fetch-all-btn:hover { background: #e63946; color: #fff; }
    .fetch-all-btn:disabled { opacity: 0.5; cursor: wait; }

    /* RESULTS */
    .results-area {
      max-width: 720px;
      margin: 0 auto;
      padding: 24px;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      padding-bottom: 12px;
      border-bottom: 1px solid #1a1a1a;
    }

    .section-emoji { font-size: 28px; }

    .section-title {
      font-family: 'Playfair Display', serif;
      font-size: 24px;
      font-weight: 700;
      color: #f5f0eb;
    }

    .section-count {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: #666;
      margin-left: auto;
    }

    /* STORY CARDS */
    .story-card {
      background: #111;
      border: 1px solid #1a1a1a;
      border-left: 3px solid #e63946;
      padding: 20px 24px;
      margin-bottom: 16px;
      cursor: pointer;
      transition: all 0.25s ease;
      animation: slideUp 0.5s ease forwards;
      opacity: 0;
      transform: translateY(20px);
    }

    @keyframes slideUp {
      to { opacity: 1; transform: translateY(0); }
    }

    .story-card:hover {
      background: #151515;
      border-left-color: #f4a261;
      transform: translateX(4px);
    }

    .story-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .heat-meter { display: flex; gap: 4px; }

    .heat-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: #222;
      display: inline-block;
      transition: all 0.3s;
    }

    .heat-dot.active {
      background: #e63946;
      box-shadow: 0 0 6px rgba(230, 57, 70, 0.5);
    }

    .story-meta-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .date-tag {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: #7b8a9e;
      letter-spacing: 0.5px;
    }

    .location-tag {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: #f4a261;
      letter-spacing: 1px;
    }

    .story-headline {
      font-family: 'Playfair Display', serif;
      font-size: 20px;
      font-weight: 700;
      color: #f5f0eb;
      line-height: 1.3;
      margin-bottom: 10px;
    }

    .story-summary {
      font-size: 14px;
      line-height: 1.6;
      color: #999;
    }

    .story-expanded {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px dashed #222;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .story-angle {
      background: #0d1117;
      border: 1px solid #1a2332;
      padding: 14px 18px;
      margin-bottom: 12px;
      border-radius: 4px;
    }

    .angle-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      font-weight: 700;
      color: #f4a261;
      letter-spacing: 2px;
      display: block;
      margin-bottom: 6px;
    }

    .story-angle p {
      font-size: 14px;
      line-height: 1.5;
      color: #ccc;
      font-style: italic;
    }

    .source-link {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: #e63946;
      text-decoration: none;
      transition: color 0.2s;
    }

    .source-link:hover { color: #f4a261; }

    .card-hint {
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      color: #333;
      text-align: right;
      margin-top: 8px;
      letter-spacing: 1px;
    }

    /* LOADING */
    .loading-container {
      text-align: center;
      padding: 48px 24px;
      animation: fadeIn 0.3s ease;
    }

    .loading-icon {
      font-size: 48px;
      margin-bottom: 16px;
      animation: bounce 1.5s ease infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .loading-text { font-size: 15px; color: #666; margin-bottom: 20px; }

    .loading-bar {
      width: 200px; height: 2px;
      background: #1a1a1a;
      margin: 0 auto;
      border-radius: 2px;
      overflow: hidden;
    }

    .loading-bar-fill {
      width: 40%; height: 100%;
      background: #e63946;
      border-radius: 2px;
      animation: loadSlide 1.5s ease infinite;
    }

    @keyframes loadSlide {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(350%); }
    }

    /* EMPTY STATE */
    .empty-state {
      text-align: center;
      padding: 80px 24px;
      color: #333;
    }

    .empty-state .big-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.3; }

    .empty-state p {
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      color: #444;
      max-width: 400px;
      margin: 0 auto;
      line-height: 1.6;
    }

    /* ERROR */
    .error-msg {
      background: #1a0a0a;
      border: 1px solid #3a1515;
      color: #e63946;
      padding: 12px 18px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      margin-bottom: 16px;
      border-radius: 4px;
    }

    /* SCROLLBAR */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0a0a0a; }
    ::-webkit-scrollbar-thumb { background: #222; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #333; }

    /* RESPONSIVE */
    @media (max-width: 600px) {
      .category-nav { padding: 12px; gap: 6px; }
      .cat-btn { padding: 6px 10px; font-size: 11px; }
      .results-area { padding: 16px; }
      .story-card { padding: 16px; }
      .story-headline { font-size: 17px; }
      .story-meta-right { flex-direction: column; align-items: flex-end; gap: 4px; }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // ========================
    // CONFIG
    // ========================
    const CATEGORIES = [
      { id: "weird", label: "Weird & Wonderful", emoji: "ü¶ë", searchQuery: "weird unusual quirky story San Francisco Bay Area site:sfgate.com OR site:sfchronicle.com OR site:sfstandard.com OR site:missionlocal.org" },
      { id: "hidden", label: "Hidden Gems", emoji: "üíé", searchQuery: "hidden gem underrated local Bay Area community story site:oaklandside.org OR site:berkeleyside.org OR site:kqed.org" },
      { id: "conflict", label: "Local Conflict", emoji: "‚ö°", searchQuery: "controversy dispute conflict Bay Area local news site:sfstandard.com OR site:mercurynews.com OR site:sfchronicle.com" },
      { id: "people", label: "People & Culture", emoji: "üé≠", searchQuery: "human interest profile story Bay Area people community site:missionlocal.org OR site:sfchronicle.com OR site:kqed.org" },
      { id: "housing", label: "Housing & Development", emoji: "üèóÔ∏è", searchQuery: "housing development gentrification Bay Area San Francisco Oakland site:sfstandard.com OR site:oaklandside.org OR site:48hills.org" },
      { id: "environment", label: "Environment & Nature", emoji: "üåø", searchQuery: "environment nature wildlife Bay Area conservation site:kqed.org OR site:sfchronicle.com OR site:mercurynews.com" },
      { id: "tech", label: "Tech Gone Wild", emoji: "ü§ñ", searchQuery: "unusual tech startup Silicon Valley San Francisco weird innovation site:sfstandard.com OR site:sfgate.com OR site:sfchronicle.com" },
      { id: "food", label: "Food & Nightlife", emoji: "üçú", searchQuery: "new restaurant food scene Bay Area San Francisco Oakland opening site:sfgate.com OR site:sfchronicle.com OR site:eater.com/san-francisco" },
      { id: "reddit", label: "Reddit Buzz", emoji: "üì°", searchQuery: "San Francisco Bay Area interesting weird funny site:reddit.com r/sanfrancisco OR r/bayarea OR r/oakland" },
      { id: "twitter", label: "X / Twitter", emoji: "ùïè", searchQuery: "San Francisco Bay Area viral trending story site:x.com OR site:twitter.com SF Oakland" },
    ];

    const SYSTEM_PROMPT = `You are a sharp-eyed news editor helping a reporter find UNIQUE, under-reported stories in the San Francisco Bay Area.

Your job: analyze search results and extract the most interesting, unusual, and potentially newsworthy stories. Focus on stories that:
- Are NOT being covered by every major outlet already
- Have a compelling human element or surprise factor
- Could become a bigger story with more reporting
- Are specific to the Bay Area (SF, Oakland, San Jose, Peninsula, East Bay, North Bay, South Bay)
- Prioritize QUIRKY, WEIRD, and ONLY-IN-SF stories ‚Äî the weirder the better

PRIORITY SOURCES (favor these heavily):
- Local papers: SF Chronicle, SFGate, SF Standard, Mission Local, Oaklandside, Berkeleyside, 48hills, KQED, Mercury News, Eater SF
- Reddit: r/sanfrancisco, r/bayarea, r/oakland ‚Äî look for viral posts, local drama, and threads blowing up
- X/Twitter: trending local posts, viral SF moments, community callouts
- These local sources often have stories that national outlets miss entirely

For Reddit and X posts: treat viral threads and heated discussions as potential story leads. Note the engagement level and community reaction.

For each story you find, respond ONLY with a JSON array (no markdown, no backticks). Each object should have:
- "headline": A punchy, editorial headline (your take, not the original)
- "summary": 2-3 sentence pitch explaining why this is worth covering (written like you're pitching to an editor)
- "angle": One sentence suggesting a unique reporting angle
- "source": The original source name (e.g. "SFGate", "r/sanfrancisco", "@username on X")
- "url": The source URL
- "date": The published date/time of the story (e.g. "Feb 12, 2026 ‚Ä¢ 8:30 AM" or "Feb 11, 2026" if no time available)
- "heat": A number 1-5 rating how unique/timely this story is (5 = drop everything)
- "location": Specific Bay Area location if known

Return 3-4 stories max. If results are thin, return fewer. Quality over quantity.`;

    // ========================
    // STATE
    // ========================
    let state = {
      apiKey: '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',
      authenticated: true,
      stories: {},
      loading: {},
      activeCategory: null,
      error: null,
      lastFetched: {},
      expandedCards: {},
    };

    function setState(updates) {
      Object.assign(state, updates);
      render();
    }

    // ========================
    // API LOGIC
    // ========================
    async function apiCall(messages) {
      const resp = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-api-key": state.apiKey,
          "anthropic-version": "2023-06-01",
          "anthropic-dangerous-direct-browser-access": "true",
        },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 1000,
          system: SYSTEM_PROMPT,
          tools: [{ type: "web_search_20250305", name: "web_search" }],
          messages,
        }),
      });
      return resp.json();
    }

    async function fetchStories(category) {
      setState({
        activeCategory: category.id,
        loading: { ...state.loading, [category.id]: true },
        error: null,
      });

      try {
        const userMsg = `Search for unique, under-reported ${category.label.toLowerCase()} stories in the Bay Area from the past few days. Query: "${category.searchQuery}". Find the most interesting and unusual ones that a local reporter could pursue.`;
        let messages = [{ role: "user", content: userMsg }];
        let currentData = await apiCall(messages);

        if (currentData.error) {
          setState({
            error: `API error: ${currentData.error.message || JSON.stringify(currentData.error)}`,
            loading: { ...state.loading, [category.id]: false },
          });
          return;
        }

        let maxLoops = 5;
        while (currentData.stop_reason === "tool_use" && maxLoops > 0) {
          maxLoops--;
          messages.push({ role: "assistant", content: currentData.content });
          const toolResults = currentData.content
            .filter(b => b.type === "tool_use")
            .map(b => ({ type: "tool_result", tool_use_id: b.id, content: "Search completed. Please analyze results and provide JSON." }));
          messages.push({ role: "user", content: toolResults });
          currentData = await apiCall(messages);
          if (currentData.error) {
            setState({
              error: `API error: ${currentData.error.message || JSON.stringify(currentData.error)}`,
              loading: { ...state.loading, [category.id]: false },
            });
            return;
          }
        }

        const textContent = currentData.content
          ?.filter(b => b.type === "text")
          .map(b => b.text)
          .join("\n");

        if (textContent) {
          let cleaned = textContent.replace(/```json\s?/g, "").replace(/```/g, "").trim();
          const arrayMatch = cleaned.match(/\[[\s\S]*\]/);
          if (arrayMatch) cleaned = arrayMatch[0];
          try {
            const parsed = JSON.parse(cleaned);
            if (Array.isArray(parsed) && parsed.length > 0) {
              const sorted = [...parsed].sort((a, b) => {
                const dateA = a.date ? new Date(a.date.replace(/‚Ä¢/g, "")) : new Date(0);
                const dateB = b.date ? new Date(b.date.replace(/‚Ä¢/g, "")) : new Date(0);
                return dateB - dateA;
              });
              setState({
                stories: { ...state.stories, [category.id]: sorted },
                lastFetched: { ...state.lastFetched, [category.id]: new Date() },
                loading: { ...state.loading, [category.id]: false },
              });
              return;
            }
          } catch (e) {
            setState({
              error: `Parse error. Raw: ${textContent.substring(0, 200)}...`,
              loading: { ...state.loading, [category.id]: false },
            });
            return;
          }
        }

        setState({
          error: `Unexpected response. Stop: ${currentData.stop_reason}`,
          loading: { ...state.loading, [category.id]: false },
        });
      } catch (err) {
        setState({
          error: `Network error: ${err.message}`,
          loading: { ...state.loading, [category.id]: false },
        });
      }
    }

    async function fetchAll() {
      for (const cat of CATEGORIES) {
        await fetchStories(cat);
        await new Promise(r => setTimeout(r, 800));
      }
    }

    // ========================
    // RENDER
    // ========================
    function render() {
      const app = document.getElementById('app');
      if (!state.authenticated) {
        app.innerHTML = renderKeyScreen();
        attachKeyListeners();
        return;
      }
      app.innerHTML = renderMainApp();
      attachMainListeners();
    }

    function renderKeyScreen() {
      return `
        <div class="key-screen">
          <div class="subtitle">AI-Powered Story Scanner ‚Ä¢ Bay Area Edition</div>
          <h1>The <em>Beat</em> Sheet</h1>
          <p style="margin-top: 24px;">Enter your Anthropic API key to power the story scanner. Your key is stored locally in your browser and never sent anywhere except Anthropic's API.</p>
          <div class="key-input-wrap">
            <input id="key-input" type="password" placeholder="sk-ant-..." value="${state.apiKey}" />
            <button id="key-submit">Launch ‚Üí</button>
          </div>
          <div class="key-note">
            Don't have a key? Get one at <a href="https://console.anthropic.com/" target="_blank">console.anthropic.com</a>. Requires web search enabled on your plan.
          </div>
        </div>
      `;
    }

    function renderMainApp() {
      const now = new Date();
      const greeting = now.getHours() < 12 ? "Good morning" : now.getHours() < 17 ? "Good afternoon" : "Good evening";
      const dateStr = now.toLocaleDateString("en-US", { weekday: "long", year: "numeric", month: "long", day: "numeric" });
      const anyLoading = Object.values(state.loading).some(Boolean);
      const activeCat = CATEGORIES.find(c => c.id === state.activeCategory);
      const currentStories = state.activeCategory ? state.stories[state.activeCategory] : null;
      const isLoading = state.activeCategory ? state.loading[state.activeCategory] : false;

      return `
        <header class="masthead">
          <div class="edition-label">AI-Powered Story Scanner ‚Ä¢ Bay Area Edition</div>
          <h1>The <em>Beat</em> Sheet</h1>
          <div class="top-bar">
            <div class="date-line">${dateStr}</div>
          </div>
          <div class="greeting">${greeting}. What stories are hiding today?</div>
        </header>

        <nav class="category-nav">
          ${CATEGORIES.map(cat => `
            <button
              class="cat-btn ${state.activeCategory === cat.id ? 'active' : ''} ${state.stories[cat.id] ? 'has-stories' : ''}"
              data-cat-id="${cat.id}"
              ${state.loading[cat.id] ? 'disabled' : ''}
            >
              <span class="dot"></span>
              ${cat.emoji} ${cat.label}
            </button>
          `).join('')}
        </nav>

        <button class="fetch-all-btn" id="fetch-all-btn" ${anyLoading ? 'disabled' : ''}>
          ${anyLoading ? 'Scanning...' : '‚ö° Scan All Categories'}
        </button>

        <div class="results-area">
          ${state.error ? `<div class="error-msg">‚ö† ${state.error}</div>` : ''}

          ${isLoading && activeCat ? `
            <div class="loading-container">
              <div class="loading-icon">${activeCat.emoji}</div>
              <div class="loading-text">Scanning the Bay for <strong>${activeCat.label.toLowerCase()}</strong> stories...</div>
              <div class="loading-bar"><div class="loading-bar-fill"></div></div>
            </div>
          ` : ''}

          ${!isLoading && currentStories && currentStories.length > 0 ? `
            <div class="section-header">
              <span class="section-emoji">${activeCat.emoji}</span>
              <span class="section-title">${activeCat.label}</span>
              <span class="section-count">
                ${currentStories.length} stories ‚Ä¢
                ${state.lastFetched[state.activeCategory]?.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) || ''}
              </span>
            </div>
            ${currentStories.map((story, i) => renderStoryCard(story, i)).join('')}
          ` : ''}

          ${!isLoading && !currentStories && !state.error ? `
            <div class="empty-state">
              <div class="big-icon">üóûÔ∏è</div>
              <p>Pick a category above or hit "Scan All" to find today's stories. Each category uses AI + live web search to find unique angles you won't see on the front page.</p>
            </div>
          ` : ''}
        </div>
      `;
    }

    function renderStoryCard(story, index) {
      const cardId = `card-${state.activeCategory}-${index}`;
      const expanded = state.expandedCards[cardId];
      const heatDots = Array.from({ length: 5 }, (_, i) =>
        `<span class="heat-dot ${i < story.heat ? 'active' : ''}"></span>`
      ).join('');

      return `
        <div class="story-card" data-card-id="${cardId}" style="animation-delay: ${index * 0.12}s;">
          <div class="story-header">
            <div class="heat-meter">${heatDots}</div>
            <div class="story-meta-right">
              ${story.date ? `<span class="date-tag">üïê ${story.date}</span>` : ''}
              ${story.location ? `<span class="location-tag">üìç ${story.location}</span>` : ''}
            </div>
          </div>
          <h3 class="story-headline">${story.headline}</h3>
          <p class="story-summary">${story.summary}</p>
          ${expanded ? `
            <div class="story-expanded">
              <div class="story-angle">
                <span class="angle-label">YOUR ANGLE ‚Üí</span>
                <p>${story.angle}</p>
              </div>
              <a href="${story.url}" target="_blank" rel="noopener noreferrer" class="source-link" onclick="event.stopPropagation()">
                Source: ${story.source} ‚Üó
              </a>
            </div>
          ` : ''}
          <div class="card-hint">${expanded ? 'click to collapse' : 'click for angle + source'}</div>
        </div>
      `;
    }

    // ========================
    // EVENT LISTENERS
    // ========================
    function attachKeyListeners() {
      document.getElementById('key-submit')?.addEventListener('click', () => {
        const key = document.getElementById('key-input').value.trim();
        if (key) {
          localStorage.setItem('beatsheet_key', key);
          setState({ apiKey: key, authenticated: true });
        }
      });
      document.getElementById('key-input')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') document.getElementById('key-submit').click();
      });
    }

    function attachMainListeners() {
      document.getElementById('fetch-all-btn')?.addEventListener('click', fetchAll);

      document.querySelectorAll('.cat-btn[data-cat-id]').forEach(btn => {
        btn.addEventListener('click', () => {
          const catId = btn.dataset.catId;
          const cat = CATEGORIES.find(c => c.id === catId);
          if (cat) fetchStories(cat);
        });
      });

      document.querySelectorAll('.story-card[data-card-id]').forEach(card => {
        card.addEventListener('click', (e) => {
          if (e.target.closest('.source-link')) return;
          const cardId = card.dataset.cardId;
          setState({
            expandedCards: { ...state.expandedCards, [cardId]: !state.expandedCards[cardId] }
          });
        });
      });
    }

    // ========================
    // INIT
    // ========================
    render();
  </script>
</body>
</html>
